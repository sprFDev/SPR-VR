<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Immersive VR Scene with Flexible Controller Support</title>
    <meta name="description" content="Immersive VR Scene with Objects Floating Around User">
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-event-set-component@5.0.0/dist/aframe-event-set-component.min.js"></script>
  </head>
  <body>
    <a-scene>
      <a-assets>
        <audio id="click-sound" src="https://cdn.aframe.io/360-image-gallery-boilerplate/audio/click.ogg"></audio>
        <img id="sky" src="stunning-starry-sky.jpg">
        <img id="sprandco-logo" src="01Compliance_Management_Tool.png" alt="Sprandco Logo">
        <img id="Compliance-Management-Tool"  src="02-Invoice-Management-System.png" alt="Sprandco Logo">
        <img id="Inventory-Management-System" src="03-Inventory-Management-System.png" alt="Sprandco Logo">
        <img id="Weighbridge-Management-System" src="04-Weighbridge-Management-System.png" alt="Sprandco Logo">
      </a-assets>

      <!-- 360-degree image background -->
      <a-sky id="image-360" radius="30" src="#sky"></a-sky>

      <!-- Interactive VR objects -->
      <a-entity id="vr-content">
        <a-box class="interactive" id="sprandco-box" material="src: #sprandco-logo"
               animation="property: rotation; to: 360 360 0; loop: true; dur: 10000"
               event-set__enter="_event: mouseenter; scale: 1.2 1.2 1.2"
               event-set__leave="_event: mouseleave; scale: 1 1 1">
        </a-box>
        
        <a-box class="interactive" id="compliance-box" material="src: #Compliance-Management-Tool"
               animation="property: rotation; to: 360 0 360; loop: true; dur: 12000"
               event-set__enter="_event: mouseenter; scale: 1.2 1.2 1.2"
               event-set__leave="_event: mouseleave; scale: 1 1 1">
        </a-box>
        
        <a-box class="interactive" id="inventory-box" material="src: #Inventory-Management-System"
               animation="property: rotation; to: 0 360 360; loop: true; dur: 15000"
               event-set__enter="_event: mouseenter; scale: 1.2 1.2 1.2"
               event-set__leave="_event: mouseleave; scale: 1 1 1">
        </a-box>
        
        <a-box class="interactive" id="weighbridge-box" material="src: #Weighbridge-Management-System"
               animation="property: rotation; to: 360 360 360; loop: true; dur: 18000"
               event-set__enter="_event: mouseenter; scale: 1.2 1.2 1.2"
               event-set__leave="_event: mouseleave; scale: 1 1 1">
        </a-box>
      </a-entity>

      <!-- Text feedback entity -->
      <a-entity id="feedback-text" position="0 0 -3" text="value: ; align: center; color: #FFF; width: 2" visible="false"></a-entity>

      <!-- Camera and cursor -->
      <a-entity id="rig" movement-controls="constrainToNavMesh: false;">
        <a-camera>
          <a-cursor id="cursor" animation__click="property: scale; startEvents: click; from: 0.1 0.1 0.1; to: 1 1 1; dur: 150"
                    animation__fusing="property: fusing; startEvents: fusing; from: 1 1 1; to: 0.1 0.1 0.1; dur: 1500"
                    event-set__mouseenter="_event: mouseenter; color: springgreen"
                    event-set__mouseleave="_event: mouseleave; color: black"
                    raycaster="objects: .interactive"></a-cursor>
        </a-camera>
      </a-entity>
      
      <!-- Flexible Controller Setup -->
      <a-entity id="controller" laser-controls="hand: right" raycaster="objects: .interactive;" line="color: #FF00FF" flexible-controller></a-entity>
    </a-scene>

    <script>
      // Function to generate a random position on a sphere
      function randomSpherePoint(radius) {
        var u = Math.random();
        var v = Math.random();
        var theta = 2 * Math.PI * u;
        var phi = Math.acos(2 * v - 1);
        var x = radius * Math.sin(phi) * Math.cos(theta);
        var y = radius * Math.sin(phi) * Math.sin(theta);
        var z = radius * Math.cos(phi);
        return {x: x, y: y, z: z};
      }

      // Position objects randomly around the user
      var radius = 5; // Distance from the center
      document.querySelectorAll('.interactive').forEach(function (el) {
        var position = randomSpherePoint(radius);
        el.setAttribute('position', position);
      });

      AFRAME.registerComponent('click-handler', {
        init: function () {
          var el = this.el;
          var feedbackText = document.querySelector('#feedback-text');
          
          el.addEventListener('click', function () {
            // Play click sound
            var clickSound = document.querySelector('#click-sound');
            clickSound.play();
            
            // Show feedback text
            feedbackText.setAttribute('text', 'value', 'Clicked: ' + el.id);
            feedbackText.setAttribute('visible', true);
            
            // Update feedback text position to always face the user
            var cameraEl = document.querySelector('[camera]');
            var cameraPosition = cameraEl.getAttribute('position');
            var direction = new THREE.Vector3().subVectors(cameraPosition, el.getAttribute('position')).normalize();
            var textPosition = new THREE.Vector3().addVectors(el.getAttribute('position'), direction.multiplyScalar(1));
            feedbackText.setAttribute('position', textPosition);
            feedbackText.setAttribute('look-at', '[camera]');
            
            // Hide feedback text after 2 seconds
            setTimeout(function () {
              feedbackText.setAttribute('visible', false);
            }, 2000);
            
            // Add click effect (e.g., brief color change)
            var originalColor = el.getAttribute('material').color;
            el.setAttribute('material', 'color', '#FFF');
            setTimeout(function () {
              el.setAttribute('material', 'color', originalColor);
            }, 150);
          });
        }
      });

      // Add click-handler component to all interactive objects
      document.querySelectorAll('.interactive').forEach(function (el) {
        el.setAttribute('click-handler', '');
      });

      // Function to slowly move objects around
      function moveObjects() {
        document.querySelectorAll('.interactive').forEach(function (el) {
          var currentPosition = el.getAttribute('position');
          var newPosition = randomSpherePoint(radius);
          el.setAttribute('animation__position', {
            property: 'position',
            dur: 20000 + Math.random() * 10000,
            easing: 'easeInOutSine',
            to: newPosition.x + ' ' + newPosition.y + ' ' + newPosition.z
          });
        });
        setTimeout(moveObjects, 30000); // Move objects every 30 seconds
      }

      // Start moving objects
      moveObjects();

      // Flexible controller component
      AFRAME.registerComponent('flexible-controller', {
        init: function () {
          var el = this.el;
          var rig = document.querySelector('#rig');
          var movementSpeed = 0.1;
          var isMovingForward = false;
          var isMovingBackward = false;

          // Function to move in the direction the controller is pointing
          function move(direction) {
            var rotation = el.object3D.rotation;
            var moveVector = new THREE.Vector3(0, 0, -direction * movementSpeed);
            moveVector.applyQuaternion(el.object3D.quaternion);
            rig.object3D.position.add(moveVector);
          }

          // Handle button presses
          el.addEventListener('buttondown', function (evt) {
            console.log('Button pressed:', evt.detail.id);
            if (evt.detail.id === 3) { // Volume up
              isMovingForward = true;
            } else if (evt.detail.id === 1) { // Volume down
              isMovingBackward = true;
            }
          });

          // Handle button releases
          el.addEventListener('buttonup', function (evt) {
            if (evt.detail.id === 3) { // Volume up
              isMovingForward = false;
            } else if (evt.detail.id === 1) { // Volume down
              isMovingBackward = false;
            }
          });

          // Handle all possible click events
          ['click', 'triggerdown', 'menudown', 'gripdown', 'trackpaddown', 'thumbstickdown'].forEach(function(eventName) {
            el.addEventListener(eventName, function (evt) {
              console.log(eventName + ' event triggered');
              // Trigger click on focused object
              var focused = document.querySelector(':hover');
              if (focused && focused.classList.contains('interactive')) {
                focused.emit('click');
              }
            });
          });

          // Continuous movement update
          this.tick = function () {
            if (isMovingForward) {
              move(1);
            }
            if (isMovingBackward) {
              move(-1);
            }
          };
        }
      });

      // Add flexible-controller component to the controller entity
      document.querySelector('#controller').setAttribute('flexible-controller', '');
    </script>
  </body>
</html>
