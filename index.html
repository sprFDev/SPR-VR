<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Immersive VR Scene with Flexible Controller Support</title>
    <meta name="description" content="Immersive VR Scene with Objects Floating Around User">
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-event-set-component@5.0.0/dist/aframe-event-set-component.min.js"></script>
    <script src="https://unpkg.com/aframe-animation-component@5.1.2/dist/aframe-animation-component.min.js"></script>
  </head>
  <body>
    <a-scene>
      <!-- Assets and other scene elements remain the same -->

      <!-- Camera and cursor -->
      <a-entity id="rig" movement-controls="constrainToNavMesh: false;">
        <a-camera>
          <a-cursor id="cursor" animation__click="property: scale; startEvents: click; from: 0.1 0.1 0.1; to: 1 1 1; dur: 150"
                    animation__fusing="property: fusing; startEvents: fusing; from: 1 1 1; to: 0.1 0.1 0.1; dur: 1500"
                    event-set__mouseenter="_event: mouseenter; color: springgreen"
                    event-set__mouseleave="_event: mouseleave; color: black"
                    raycaster="objects: .interactive"></a-cursor>
        </a-camera>
      </a-entity>
      
      <!-- Flexible Controller Setup -->
      <a-entity id="controller" laser-controls="hand: right" raycaster="objects: .interactive;" line="color: #FF00FF" flexible-controller></a-entity>
    </a-scene>

    <script>
      // Previous functions (randomSpherePoint, click-handler, moveObjects) remain the same

      // Flexible controller component
      AFRAME.registerComponent('flexible-controller', {
        init: function () {
          var el = this.el;
          var rig = document.querySelector('#rig');
          var movementSpeed = 0.1;
          var isMovingForward = false;
          var isMovingBackward = false;

          // Function to move in the direction the controller is pointing
          function move(direction) {
            var rotation = el.object3D.rotation;
            var moveVector = new THREE.Vector3(0, 0, -direction * movementSpeed);
            moveVector.applyQuaternion(el.object3D.quaternion);
            rig.object3D.position.add(moveVector);
          }

          // Handle button presses
          el.addEventListener('buttondown', function (evt) {
            console.log('Button pressed:', evt.detail.id);
            if (evt.detail.id === 3) { // Volume up
              isMovingForward = true;
            } else if (evt.detail.id === 1) { // Volume down
              isMovingBackward = true;
            }
          });

          // Handle button releases
          el.addEventListener('buttonup', function (evt) {
            if (evt.detail.id === 3) { // Volume up
              isMovingForward = false;
            } else if (evt.detail.id === 1) { // Volume down
              isMovingBackward = false;
            }
          });

          // Handle all possible click events
          ['click', 'triggerdown', 'menudown', 'gripdown', 'trackpaddown', 'thumbstickdown'].forEach(function(eventName) {
            el.addEventListener(eventName, function (evt) {
              console.log(eventName + ' event triggered');
              // Trigger click on focused object
              var focused = document.querySelector(':hover');
              if (focused && focused.classList.contains('interactive')) {
                focused.emit('click');
              }
            });
          });

          // Continuous movement update
          this.tick = function () {
            if (isMovingForward) {
              move(1);
            }
            if (isMovingBackward) {
              move(-1);
            }
          };
        }
      });

      // Add flexible-controller component to the controller entity
      document.querySelector('#controller').setAttribute('flexible-controller', '');
    </script>
  </body>
</html>
